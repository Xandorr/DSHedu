<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>게시글 수정 | DSH에듀</title>
  <meta name="description" content="DSH에듀 커뮤니티 게시글 수정">
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- AOS Animation Library -->
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Custom CSS -->
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>

<%- include('../partials/header') %>

<div class="container-fluid py-5" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 30vh;">
  <div class="container">
    <div class="row justify-content-center text-center text-white">
      <div class="col-lg-8">
        <h1 class="display-5 fw-bold mb-3" data-aos="fade-up">
          <i class="fas fa-edit me-3"></i>게시글 수정
        </h1>
        <p class="lead mb-0" data-aos="fade-up" data-aos-delay="100">
          게시글을 수정해보세요
        </p>
      </div>
    </div>
  </div>
</div>

<div class="container my-5">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <div class="card border-0 shadow-lg">
        <div class="card-body p-5">
          <form action="/posts/<%= post._id %>/edit" method="POST" enctype="multipart/form-data" id="postForm">
            <!-- 제목 -->
            <div class="mb-4">
              <label for="title" class="form-label fw-bold">
                <i class="fas fa-heading me-2 text-primary"></i>제목 *
              </label>
              <input type="text" class="form-control form-control-lg" id="title" name="title" 
                     placeholder="제목을 입력하세요" required maxlength="200"
                     value="<%= post.title %>">
              <div class="form-text">최대 200자까지 입력 가능합니다.</div>
            </div>

            <!-- 카테고리 -->
            <div class="row mb-4">
              <div class="col-md-6">
                <label for="category" class="form-label fw-bold">
                  <i class="fas fa-folder me-2 text-primary"></i>카테고리
                </label>
                <select class="form-select" id="category" name="category">
                  <option value="general" <%= post.category === 'general' ? 'selected' : '' %>>
                    자유게시판
                  </option>
                  <option value="info" <%= post.category === 'info' ? 'selected' : '' %>>
                    정보 공유
                  </option>
                  <option value="qna" <%= post.category === 'qna' ? 'selected' : '' %>>
                    Q&A
                  </option>
                  <% if (user && user.role === 'admin') { %>
                  <option value="notice" <%= post.category === 'notice' ? 'selected' : '' %>>
                    공지사항
                  </option>
                  <% } %>
                </select>
              </div>
              <div class="col-md-6">
                <label for="tags" class="form-label fw-bold">
                  <i class="fas fa-tags me-2 text-primary"></i>태그
                </label>
                <input type="text" class="form-control" id="tags" name="tags" 
                       placeholder="태그1, 태그2, 태그3" 
                       value="<%= post.tags ? post.tags.join(', ') : '' %>">
                <div class="form-text">쉼표(,)로 구분하여 입력하세요.</div>
              </div>
            </div>

            <!-- 내용 -->
            <div class="mb-4">
              <label for="content" class="form-label fw-bold">
                <i class="fas fa-align-left me-2 text-primary"></i>내용 *
              </label>
              <textarea class="form-control" id="content" name="content" rows="15" 
                        placeholder="내용을 입력하세요..." required><%= post.content %></textarea>
            </div>

            <!-- 기존 이미지 -->
            <% if (post.images && post.images.length > 0) { %>
              <div class="mb-4">
                <label class="form-label fw-bold">
                  <i class="fas fa-image me-2 text-primary"></i>기존 이미지
                </label>
                <div class="row" id="existingImages">
                  <% post.images.forEach((image, index) => { %>
                    <div class="col-md-3 col-sm-6 mb-3" data-image-index="<%= index %>">
                      <div class="existing-image position-relative">
                        <img src="<%= image %>" alt="기존 이미지 <%= index + 1 %>" 
                             class="img-fluid rounded" style="aspect-ratio: 16/9; object-fit: cover;">
                        <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1" 
                                onclick="removeExistingImage(<%= index %>)">
                          <i class="fas fa-times"></i>
                        </button>
                      </div>
                    </div>
                  <% }) %>
                </div>
              </div>
            <% } %>

            <!-- 새 이미지 업로드 -->
            <div class="mb-4">
              <label for="images" class="form-label fw-bold">
                <i class="fas fa-image me-2 text-primary"></i>새 이미지 추가
              </label>
              <input type="file" class="form-control" id="images" name="images" 
                     multiple accept="image/*" onchange="previewImages(this)">
              <div class="form-text">최대 5개까지, 각 파일 최대 5MB까지 업로드 가능합니다.</div>
              
              <!-- 새 이미지 미리보기 -->
              <div id="imagePreview" class="row mt-3"></div>
            </div>

            <!-- 유튜브 URL -->
            <div class="mb-4">
              <label for="youtubeUrl" class="form-label fw-bold">
                <i class="fab fa-youtube me-2 text-danger"></i>유튜브 링크
              </label>
              <input type="url" class="form-control" id="youtubeUrl" name="youtubeUrl" 
                     placeholder="https://www.youtube.com/watch?v=..."
                     value="<%= post.youtubeUrl || '' %>">
              <div class="form-text">유튜브 영상을 첨부하고 싶다면 링크를 입력하세요.</div>
            </div>

            <!-- 버튼 -->
            <div class="d-flex justify-content-between align-items-center pt-4">
              <a href="/posts/<%= post._id %>" class="btn btn-outline-secondary btn-lg">
                <i class="fas fa-arrow-left me-2"></i>취소
              </a>
              <div>
                <button type="button" class="btn btn-outline-primary btn-lg me-2" onclick="saveDraft()">
                  <i class="fas fa-save me-2"></i>임시저장
                </button>
                <button type="submit" class="btn btn-primary btn-lg">
                  <i class="fas fa-check me-2"></i>수정완료
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .form-control:focus,
  .form-select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
  }
  
  .preview-image {
    position: relative;
    overflow: hidden;
    border-radius: 8px;
  }
  
  .preview-image img {
    width: 100%;
    height: 150px;
    object-fit: cover;
  }
  
  .remove-image {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(0,0,0,0.7);
    color: white;
    border: none;
    border-radius: 50%;
    width: 25px;
    height: 25px;
    font-size: 12px;
    cursor: pointer;
  }
  
  .existing-image {
    overflow: hidden;
    border-radius: 8px;
  }
  
  #content {
    font-family: 'Noto Sans KR', sans-serif;
    line-height: 1.6;
  }
</style>

<script>
// 삭제할 기존 이미지 인덱스들을 저장
let imagesToRemove = [];

// 새 이미지 미리보기
function previewImages(input) {
  const preview = document.getElementById('imagePreview');
  preview.innerHTML = '';
  
  if (input.files) {
    Array.from(input.files).forEach((file, index) => {
      if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
          const col = document.createElement('div');
          col.className = 'col-md-3 col-sm-6 mb-3';
          
          col.innerHTML = `
            <div class="preview-image">
              <img src="${e.target.result}" alt="Preview ${index + 1}">
              <button type="button" class="remove-image" onclick="removeNewImage(${index})">
                <i class="fas fa-times"></i>
              </button>
            </div>
          `;
          
          preview.appendChild(col);
        };
        
        reader.readAsDataURL(file);
      }
    });
  }
}

// 새 이미지 제거
function removeNewImage(index) {
  const input = document.getElementById('images');
  const dt = new DataTransfer();
  
  Array.from(input.files).forEach((file, i) => {
    if (i !== index) {
      dt.items.add(file);
    }
  });
  
  input.files = dt.files;
  previewImages(input);
}

// 기존 이미지 제거
function removeExistingImage(index) {
  const imageDiv = document.querySelector(`[data-image-index="${index}"]`);
  if (imageDiv) {
    imageDiv.style.display = 'none';
    imagesToRemove.push(index);
  }
}

// 임시저장
function saveDraft() {
  const formData = {
    title: document.getElementById('title').value,
    content: document.getElementById('content').value,
    category: document.getElementById('category').value,
    tags: document.getElementById('tags').value,
    youtubeUrl: document.getElementById('youtubeUrl').value
  };
  
  localStorage.setItem('postEditDraft_<%= post._id %>', JSON.stringify(formData));
  
  // 알림 표시
  const alert = document.createElement('div');
  alert.className = 'alert alert-success alert-dismissible fade show position-fixed';
  alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
  alert.innerHTML = `
    <i class="fas fa-check-circle me-2"></i>임시저장되었습니다.
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  
  document.body.appendChild(alert);
  
  setTimeout(() => {
    if (alert.parentNode) {
      alert.parentNode.removeChild(alert);
    }
  }, 3000);
}

// 임시저장된 내용 불러오기
document.addEventListener('DOMContentLoaded', function() {
  const draft = localStorage.getItem('postEditDraft_<%= post._id %>');
  if (draft) {
    if (confirm('임시저장된 수정 내용이 있습니다. 불러오시겠습니까?')) {
      const data = JSON.parse(draft);
      
      document.getElementById('title').value = data.title || '';
      document.getElementById('content').value = data.content || '';
      document.getElementById('category').value = data.category || 'general';
      document.getElementById('tags').value = data.tags || '';
      document.getElementById('youtubeUrl').value = data.youtubeUrl || '';
    }
  }
});

// 폼 제출 시 임시저장 내용 삭제 및 삭제할 이미지 정보 추가
document.getElementById('postForm').addEventListener('submit', function(e) {
  // 삭제할 이미지 정보를 hidden input으로 추가
  if (imagesToRemove.length > 0) {
    const hiddenInput = document.createElement('input');
    hiddenInput.type = 'hidden';
    hiddenInput.name = 'removeImages';
    hiddenInput.value = JSON.stringify(imagesToRemove);
    this.appendChild(hiddenInput);
  }
  
  localStorage.removeItem('postEditDraft_<%= post._id %>');
});

// 글자 수 카운터 (제목)
document.getElementById('title').addEventListener('input', function() {
  const maxLength = 200;
  const currentLength = this.value.length;
  const helpText = this.nextElementSibling;
  
  helpText.textContent = `${currentLength}/${maxLength}자`;
  
  if (currentLength > maxLength * 0.9) {
    helpText.classList.add('text-warning');
  } else {
    helpText.classList.remove('text-warning');
  }
});

// 초기 글자 수 설정
document.getElementById('title').dispatchEvent(new Event('input'));
</script>

<%- include('../partials/footer') %>

<!-- Bootstrap JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- AOS Animation Library -->
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script>
  AOS.init();
</script>

</body>
</html> 