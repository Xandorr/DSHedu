<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>커뮤니티 | DSH에듀</title>
  <meta name="description" content="DSH에듀 회원 커뮤니티 - 자유게시판, 정보공유, Q&A, 공지사항을 통해 다양한 정보를 나누세요">
  <meta name="keywords" content="DSH에듀, 커뮤니티, 자유게시판, 정보공유, Q&A, 공지사항, 교육, 캠프">
  
  <!-- Open Graph 메타 태그 -->
  <meta property="og:title" content="커뮤니티 | DSH에듀">
  <meta property="og:description" content="DSH에듀 회원 커뮤니티 - 자유게시판, 정보공유, Q&A, 공지사항을 통해 다양한 정보를 나누세요">
  <meta property="og:type" content="website">
  <meta property="og:url" content="<%= req.protocol %>://<%= req.get('host') %>/posts">
  <meta property="og:site_name" content="DSH에듀">
  <meta property="og:image" content="<%= req.protocol %>://<%= req.get('host') %>/images/logo.png">
  <meta property="og:locale" content="ko_KR">
  
  <!-- 트위터 카드 메타 태그 -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="커뮤니티 | DSH에듀">
  <meta name="twitter:description" content="DSH에듀 회원 커뮤니티 - 자유게시판, 정보공유, Q&A, 공지사항을 통해 다양한 정보를 나누세요">
  <meta name="twitter:image" content="<%= req.protocol %>://<%= req.get('host') %>/images/logo.png">
  
  <!-- 기타 SEO 메타 태그 -->
  <meta name="robots" content="index, follow">
  <meta name="googlebot" content="index, follow">
  <link rel="canonical" href="<%= req.protocol %>://<%= req.get('host') %>/posts">
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <!-- AOS Animation Library - 지연 로딩 -->
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet" media="print" onload="this.media='all'">
  
  <!-- Google Fonts - 최적화된 로딩 -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  
  <!-- Custom CSS -->
  <link rel="stylesheet" href="/css/style.css">
  
  <style>
    /* 세련된 커뮤니티 헤더 스타일 */
    .hero-section {
      position: relative;
      min-height: 65vh;
      display: flex;
      align-items: center;
      overflow: hidden;
    }
    
    .hero-background {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1;
    }
    
    .gradient-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #667eea 100%);
      z-index: 1;
    }
    
    .pattern-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: 
        radial-gradient(circle at 20% 80%, rgba(255,255,255,0.08) 0%, transparent 40%),
        radial-gradient(circle at 80% 20%, rgba(255,255,255,0.04) 0%, transparent 40%);
      background-size: 200px 200px, 150px 150px;
      z-index: 2;
      will-change: auto;
    }
    
    .hero-content {
      z-index: 3;
    }
    
    /* 배지 스타일 */
    .hero-badge-wrapper {
      display: flex;
      align-items: center;
    }
    
    .hero-badge {
      position: relative;
      display: inline-flex;
      align-items: center;
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 50px;
      padding: 0.8rem 1.5rem;
      color: white;
      font-weight: 500;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
      will-change: transform;
    }
    
    .badge-icon {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 0.8rem;
      font-size: 0.9rem;
    }
    
    .badge-text {
      font-size: 0.95rem;
      letter-spacing: 0.5px;
    }
    
    .badge-glow {
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, rgba(255,255,255,0.1), rgba(255,215,0,0.1));
      border-radius: 50px;
      z-index: -1;
      opacity: 0.6;
    }
    
    /* 타이틀 스타일 */
    .hero-title {
      font-size: 3.8rem;
      font-weight: 700;
      line-height: 1.2;
      color: white;
      text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    
    .title-line-1 {
      display: block;
      margin-bottom: 0.5rem;
    }
    
    .title-line-2 {
      display: block;
    }
    
    .gradient-text {
      background: linear-gradient(45deg, #ffd700, #ffeb3b, #ffc107);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: none;
    }
    
    /* 설명 텍스트 */
    .hero-description {
      font-size: 1.25rem;
      color: rgba(255, 255, 255, 0.9);
      line-height: 1.6;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }
    
    /* 통계 카드들 */
    .stats-container {
      display: flex;
      gap: 1.5rem;
    }
    
    .stat-card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 20px;
      padding: 1.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      transition: all 0.3s ease;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }
    
    .stat-card:hover {
      transform: translateY(-2px);
      background: rgba(255, 255, 255, 0.15);
      box-shadow: 0 12px 48px rgba(0, 0, 0, 0.15);
    }
    
    .stat-icon {
      background: rgba(255, 215, 0, 0.2);
      border-radius: 50%;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ffd700;
      font-size: 1.2rem;
    }
    
    .stat-content {
      flex: 1;
    }
    
    .stat-number {
      font-size: 2rem;
      font-weight: 700;
      color: #ffd700;
      line-height: 1;
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    
    .stat-label {
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.8);
      margin-top: 0.25rem;
    }
    
    /* 액션 카드 */
    .action-wrapper {
      display: flex;
      justify-content: center;
    }
    
    .action-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 25px;
      padding: 2.5rem;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
      text-align: center;
      max-width: 350px;
      width: 100%;
    }
    
    .welcome-section {
      margin-bottom: 2rem;
    }
    
    .crown-icon,
    .level-icon,
    .rocket-icon {
      background: linear-gradient(45deg, #667eea, #764ba2);
      border-radius: 50%;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1rem;
      color: white;
      font-size: 1.5rem;
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }

    /* 환영 메시지 스타일 */
    .welcome-header {
      margin-bottom: 1rem;
    }

    .welcome-content {
      text-align: center;
    }

    .welcome-title {
      margin: 0 0 0.5rem 0;
      font-size: 1.1rem;
      font-weight: 600;
      color: #333;
    }

    .welcome-name-section {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      align-items: center;
    }

    .user-name {
      font-size: 1rem;
      font-weight: 500;
      color: #555;
    }

    .user-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.3rem 0.8rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
      max-width: fit-content;
    }

    .user-badge.admin-badge {
      background-color: #ffc107;
      color: #212529;
    }

    .user-badge.level-badge.level-1 {
      background-color: #6c757d;
      color: white;
    }

    .user-badge.level-badge.level-2 {
      background: linear-gradient(45deg, #c0c0c0, #e8e8e8);
      color: #333;
      border: 1px solid #b0b0b0;
    }

    .user-badge.level-badge.level-3 {
      background-color: #ffc107;
      color: #212529;
    }

    .user-badge.level-badge.level-4 {
      background: linear-gradient(45deg, #8e44ad, #9b59b6, #e74c3c);
      color: white;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    .user-badge.level-badge.level-5 {
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #feca57);
      background-size: 300% 300%;
      animation: diamondShine 3s ease-in-out infinite;
      color: white;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    @keyframes diamondShine {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    /* 게시글 목록용 실버 스타일 */
    .level-2-silver {
      background: linear-gradient(45deg, #c0c0c0, #e8e8e8) !important;
      color: #333 !important;
      border: 1px solid #b0b0b0 !important;
    }

    /* 게시글 목록용 플래티넘 스타일 */
    .level-4-platinum {
      background: linear-gradient(45deg, #8e44ad, #9b59b6, #e74c3c) !important;
      color: white !important;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3) !important;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2) !important;
    }

    /* 게시글 목록용 다이아몬드 스타일 */
    .level-5-diamond {
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #feca57) !important;
      background-size: 300% 300% !important;
      animation: diamondShine 3s ease-in-out infinite !important;
      color: white !important;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3) !important;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2) !important;
    }
    
    .welcome-title {
      color: #333;
      font-weight: 600;
      font-size: 1.3rem;
      margin-bottom: 0.5rem;
    }
    
    .welcome-name {
      color: #667eea;
      font-weight: 700;
      font-size: 1.1rem;
      margin: 0;
    }
    
    .welcome-desc {
      color: #666;
      font-size: 1rem;
      margin: 0;
    }
    
    /* 액션 버튼 */
    .action-btn {
      position: relative;
      display: inline-block;
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      padding: 1rem 2rem;
      border-radius: 50px;
      text-decoration: none;
      font-weight: 600;
      font-size: 1.1rem;
      transition: box-shadow 0.2s ease;
      border: none;
      overflow: hidden;
      box-shadow: 0 4px 16px rgba(102, 126, 234, 0.25);
      width: 100%;
      will-change: box-shadow;
    }
    
    .action-btn:hover {
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.35);
      color: white;
      text-decoration: none;
    }
    
    .btn-content {
      position: relative;
      z-index: 2;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .btn-glow {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
      border-radius: 50px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .action-btn:hover .btn-glow {
      opacity: 1;
    }
    
    /* 반응형 디자인 */
    @media (max-width: 768px) {
      .hero-section {
        min-height: 100vh;
      }
      
      .hero-title {
        font-size: 2.8rem;
      }
      
      .hero-description {
        font-size: 1.1rem;
      }
      
      .stats-container {
        flex-direction: column;
        gap: 1rem;
      }
      
      .stat-card {
        padding: 1.2rem;
      }
      
      .stat-number {
        font-size: 1.6rem;
      }
      
      .action-card {
        padding: 2rem;
        margin-top: 2rem;
      }
    }
    
    @media (max-width: 576px) {
      .hero-title {
        font-size: 2.2rem;
      }
      
      .pattern-overlay {
        display: none;
      }
    }

    /* 커뮤니티 게시판 전용 스타일 */
    .post-row {
      transition: background-color 0.2s ease, border-left-color 0.2s ease, box-shadow 0.2s ease;
      border-left: 3px solid transparent;
      position: relative;
      background-color: white;
      will-change: background-color, border-left-color, box-shadow;
    }
    
    .post-row:hover {
      background-color: #f8f9fa !important;
      border-left-color: #667eea;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      z-index: 1;
    }
    
    .table-hover > tbody > tr:hover > td {
      background-color: #f8f9fa !important;
    }
    
    .stretched-link::after {
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      z-index: 1;
      content: "";
    }
    
    .badge.rounded-pill {
      font-size: 0.7rem;
      padding: 0.3rem 0.6rem;
    }
    
    .table th {
      font-weight: 600;
      font-size: 0.9rem;
      color: #495057;
      padding: 1rem 0.75rem;
    }
    
    .table td {
      vertical-align: middle;
      border-color: #f1f3f4;
      border-bottom: 1px solid #f1f3f4;
      padding: 1rem 0.75rem;
    }
    
    .table tbody tr {
      border-bottom: 1px solid #f1f3f4;
    }
    
    .table tbody tr:last-child {
      border-bottom: none;
    }
    
    .dropdown-toggle::after {
      display: none;
    }
    
    @media (max-width: 768px) {
      .table-responsive table,
      .table-responsive thead,
      .table-responsive tbody,
      .table-responsive th,
      .table-responsive td,
      .table-responsive tr {
        display: block;
      }
      
      .table-responsive thead tr {
        position: absolute;
        top: -9999px;
        left: -9999px;
      }
      
      .table-responsive tr {
        border: 1px solid #ccc;
        margin-bottom: 10px;
        padding: 10px;
        border-radius: 8px;
        background: white;
      }
      
      .table-responsive td {
        border: none;
        padding: 0.5rem;
        position: relative;
        padding-left: 30%;
      }
      
      .table-responsive td:before {
        content: attr(data-label);
        position: absolute;
        left: 6px;
        width: 25%;
        padding-right: 10px;
        white-space: nowrap;
        font-weight: bold;
        color: #333;
      }
    }
    

  </style>
</head>
<body>

<%- include('../partials/header') %>

<!-- 세련된 커뮤니티 헤더 -->
<div class="hero-section">
  <div class="hero-background">
    <div class="gradient-overlay"></div>
    <div class="pattern-overlay"></div>
  </div>
  
  <div class="container position-relative hero-content">
    <div class="row align-items-center py-5">
      <div class="col-lg-8">
        <div class="content-wrapper">
          <!-- 상단 배지 -->
          <div class="hero-badge-wrapper mb-4">
            <div class="hero-badge">
              <div class="badge-icon">
                <i class="fas fa-users"></i>
              </div>
              <span class="badge-text">Community Space</span>
              <div class="badge-glow"></div>
            </div>
          </div>
          
          <!-- 메인 타이틀 -->
          <h1 class="hero-title mb-4">
            <span class="title-line-1">함께 만들어가는</span>
            <span class="title-line-2">
              <span class="gradient-text">커뮤니티</span>
            </span>
          </h1>
          
          <!-- 설명 텍스트 -->
          <p class="hero-description mb-5">
            DSH에듀 회원들과 함께 지식을 나누고, 경험을 공유하며, 
            <br class="d-none d-md-block">서로 성장해나가는 소통의 공간입니다
          </p>
          
          <!-- 통계 카드들 -->
          <div class="stats-container">
            <div class="stat-card">
              <div class="stat-icon">
                <i class="fas fa-file-alt"></i>
              </div>
              <div class="stat-content">
                <div class="stat-number">
                  <% if (posts && posts.length > 0) { %>
                    <%= posts.length %>
                  <% } else { %>
                    0
                  <% } %>
                </div>
                <div class="stat-label">게시글</div>
              </div>
            </div>
            
            <div class="stat-card">
              <div class="stat-icon">
                <i class="fas fa-eye"></i>
              </div>
              <div class="stat-content">
                <div class="stat-number">
                  <% if (posts && posts.length > 0) { %>
                    <%= posts.reduce((sum, post) => sum + (post.views || 0), 0) %>
                  <% } else { %>
                    0
                  <% } %>
                </div>
                <div class="stat-label">조회수</div>
              </div>
            </div>
            
                         <div class="stat-card">
               <div class="stat-icon">
                 <i class="fas fa-heart"></i>
               </div>
               <div class="stat-content">
                 <div class="stat-number">
                   <% if (posts && posts.length > 0) { %>
                     <%= posts.reduce((sum, post) => sum + (post.likes ? post.likes.length : 0), 0) %>
                   <% } else { %>
                     0
                   <% } %>
                 </div>
                 <div class="stat-label">좋아요</div>
               </div>
             </div>
          </div>
        </div>
      </div>
      
      <div class="col-lg-4">
        <div class="action-wrapper">
          <div class="action-card">
            <% if (user) { %>
              <div class="welcome-section mb-4">
                <div class="welcome-header">
                  <div class="welcome-content">
                    <h5 class="welcome-title">환영합니다!</h5>
                    <div class="welcome-name-section">
                      <span class="user-name"><%= user.name %>님</span>
                      <% if (user.role === 'admin') { %>
                        <div class="user-badge admin-badge">
                          <i class="fas fa-crown"></i>
                          <span>관리자</span>
                        </div>
                      <% } else if (user.communityLevel && user.communityLevel.level) { %>
                        <div class="user-badge level-badge level-<%= user.communityLevel.level %>">
                          <i class="<%= user.communityLevel.level === 1 ? 'fas fa-medal' : user.communityLevel.level === 2 ? 'fas fa-medal' : user.communityLevel.level === 3 ? 'fas fa-medal' : user.communityLevel.level === 4 ? 'fas fa-gem' : 'fas fa-crown' %>"></i>
                          <span><%= user.communityLevel.title %></span>
                        </div>
                      <% } %>
                    </div>
                  </div>
                </div>
              </div>
              
              <a href="/posts/create" class="action-btn primary-btn">
                <div class="btn-content">
                  <i class="fas fa-pen-fancy me-2"></i>
                  <span>새 글 작성하기</span>
                </div>
                <div class="btn-glow"></div>
              </a>
            <% } else { %>
              <div class="welcome-section mb-4">
                <div class="rocket-icon">
                  <i class="fas fa-rocket"></i>
                </div>
                <h5 class="welcome-title">지금 시작하세요!</h5>
                <p class="welcome-desc">커뮤니티에 참여해보세요</p>
              </div>
              
              <a href="/login" class="action-btn primary-btn">
                <div class="btn-content">
                  <i class="fas fa-sign-in-alt me-2"></i>
                  <span>로그인하여 참여하기</span>
                </div>
                <div class="btn-glow"></div>
              </a>
            <% } %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container my-5">


  <!-- 검색 및 필터 섹션 -->
  <div class="row mb-4">
    <div class="col-lg-8">
      <div class="d-flex flex-wrap gap-2 mb-3" id="categoryButtons">
        <button data-category="all" class="btn <%= category === 'all' ? 'btn-primary' : 'btn-outline-primary' %> btn-sm category-btn">
          <i class="fas fa-th-large me-1"></i>전체
        </button>
        <button data-category="general" class="btn <%= category === 'general' ? 'btn-primary' : 'btn-outline-primary' %> btn-sm category-btn">
          <i class="fas fa-comments me-1"></i>자유게시판
        </button>
        <button data-category="info" class="btn <%= category === 'info' ? 'btn-primary' : 'btn-outline-primary' %> btn-sm category-btn">
          <i class="fas fa-info-circle me-1"></i>정보 공유
        </button>
        <button data-category="notice" class="btn <%= category === 'notice' ? 'btn-primary' : 'btn-outline-primary' %> btn-sm category-btn">
          <i class="fas fa-bullhorn me-1"></i>공지사항
        </button>
        <button data-category="qna" class="btn <%= category === 'qna' ? 'btn-primary' : 'btn-outline-primary' %> btn-sm category-btn">
          <i class="fas fa-question-circle me-1"></i>Q&A
        </button>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="d-flex gap-2">
        <form class="d-flex flex-grow-1" id="searchForm">
          <input type="hidden" id="searchCategory" value="<%= category %>">
          <input type="text" id="searchInput" class="form-control form-control-sm" placeholder="제목, 내용, 태그 검색..." value="<%= search %>">
          <button type="submit" class="btn btn-outline-primary btn-sm ms-2" id="searchBtn">
            <i class="fas fa-search"></i>
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- 게시글 목록 -->
  <div class="row">

    
    <% if (posts && posts.length > 0) { %>
      <!-- 깔끔한 테이블 스타일 게시판 -->
      <div class="col-12">
        <div class="card border-0 shadow-sm">
          <div class="table-responsive">
            <table class="table mb-0" style="border-spacing: 0; border-collapse: separate;">
              <thead class="bg-light">
                <tr>
                  <th class="border-0 ps-4" style="width: 45%;">제목</th>
                  <th class="border-0 text-center" style="width: 15%;">작성자</th>
                  <th class="border-0 text-center" style="width: 8%;">댓글</th>
                  <th class="border-0 text-center" style="width: 8%;">조회</th>
                  <th class="border-0 text-center" style="width: 9%;">좋아요</th>
                  <th class="border-0 text-center" style="width: 15%;">작성일</th>
                </tr>
              </thead>
                             <tbody id="postsContainer">
                <% posts.forEach(post => { %>
                  <tr class="post-row" style="cursor: pointer;"
                      data-category="<%= post.category %>"
                      data-title="<%= post.title %>"
                      data-author="<%= post.author ? post.author.name : '알 수 없음' %>"
                      data-comments="<%= post.commentCount || 0 %>"
                      data-views="<%= post.views || 0 %>"
                      data-date="<%= new Date(post.createdAt).toLocaleDateString('ko-KR') %>">
                    <td class="ps-4 py-3">
                      <div class="d-flex align-items-start">
                        <div class="flex-grow-1">
                          <!-- 카테고리 배지 -->
                          <span class="badge rounded-pill me-5 
                            <%= post.category === 'notice' ? 'bg-danger' : 
                                post.category === 'info' ? 'bg-success text-white' :
                                post.category === 'qna' ? 'bg-info text-white' : 'bg-secondary' %>">
                            <%= post.category === 'general' ? '자유' :
                                post.category === 'info' ? '정보 공유' :
                                post.category === 'notice' ? '공지' :
                                post.category === 'qna' ? 'Q&A' : post.category %>
                          </span>
                          
                          <!-- 제목 -->
                          <h6 class="mb-1 fw-semibold">
                            <a href="/posts/<%= post._id %>" class="text-decoration-none text-dark stretched-link">
                              <%= post.title %>
                            </a>
                            <% if (post.category === 'notice') { %>
                              <i class="fas fa-thumbtack text-danger ms-1" title="공지사항"></i>
                            <% } %>
                            <% if (post.isPrivate) { %>
                              <i class="fas fa-lock text-warning ms-1" title="비밀글"></i>
                            <% } %>
                          </h6>
                          
                          <!-- 미리보기 -->
                          <p class="text-muted small mb-1" style="line-height: 1.4;">
                            <%= typeof post.getExcerpt === 'function' ? post.getExcerpt(80) : post.content.substring(0, 80) + '...' %>
                          </p>
                          
                          <!-- 태그 -->
                          <% if (post.tags && post.tags.length > 0) { %>
                            <div class="mt-1">
                              <% post.tags.slice(0, 3).forEach(tag => { %>
                                <span class="badge bg-light text-secondary" style="font-size: 0.7rem; margin-right: 0.1rem;">#<%= tag %></span>
                              <% }) %>
                            </div>
                          <% } %>
                        </div>
                        
                        <!-- 관리자 메뉴 -->
                        <% if (user && (user.role === 'admin' || (post.author && post.author._id && post.author._id.toString() === user._id.toString()))) { %>
                          <div class="dropdown" onclick="event.stopPropagation(); event.preventDefault();" style="position: relative; z-index: 999;">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" 
                                    data-bs-toggle="dropdown" onclick="event.stopPropagation(); event.preventDefault();">
                              <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end" style="z-index: 1000;">
                              <li><a class="dropdown-item" href="/posts/<%= post._id %>/edit" onclick="event.stopPropagation();">
                                <i class="fas fa-edit me-2"></i>수정
                              </a></li>
                              <li><a class="dropdown-item text-danger" href="#" 
                                     onclick="event.stopPropagation(); deletePost('<%= post._id %>')">
                                <i class="fas fa-trash me-2"></i>삭제
                              </a></li>
                            </ul>
                          </div>
                        <% } %>
                      </div>
                    </td>
                    
                    <!-- 작성자 -->
                    <td class="text-center py-3">
                      <div class="d-flex flex-column align-items-center">
                        <% if (post.author && post.author.profilePhoto) { %>
                          <img src="<%= post.author.profilePhoto %>" alt="프로필 사진" 
                               class="rounded-circle mb-1" style="width: 32px; height: 32px; object-fit: cover;">
                        <% } else { %>
                          <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center mb-1" 
                               style="width: 32px; height: 32px; font-size: 0.8rem;">
                            <%= post.author ? post.author.name.charAt(0).toUpperCase() : '알' %>
                          </div>
                        <% } %>
                        <div>
                          <small class="text-muted">
                            <%= post.author ? post.author.name : '알 수 없음' %>
                          </small>
                          <% if (post.author && post.author.role === 'admin') { %>
                            <div class="mt-1">
                              <span class="badge bg-warning text-dark" style="font-size: 0.6rem;">
                                <i class="fas fa-crown me-1"></i>관리자
                              </span>
                            </div>
                          <% } else if (post.author && post.author.communityLevel && post.author.communityLevel.level) { %>
                            <div class="mt-1">
                              <span class="badge <%= post.author.communityLevel.level === 1 ? 'bg-secondary' : post.author.communityLevel.level === 2 ? 'level-2-silver' : post.author.communityLevel.level === 3 ? 'bg-warning text-dark' : post.author.communityLevel.level === 4 ? 'level-4-platinum' : 'level-5-diamond' %>" style="font-size: 0.6rem;">
                                <i class="<%= post.author.communityLevel.level === 1 ? 'fas fa-medal' : post.author.communityLevel.level === 2 ? 'fas fa-medal' : post.author.communityLevel.level === 3 ? 'fas fa-medal' : post.author.communityLevel.level === 4 ? 'fas fa-gem' : 'fas fa-crown' %> me-1"></i>
                                <%= post.author.communityLevel.title %>
                              </span>
                            </div>
                          <% } %>
                        </div>
                      </div>
                    </td>
                    
                    <!-- 댓글 수 -->
                    <td class="text-center py-3">
                      <span class="text-primary fw-semibold">
                        <i class="fas fa-comment me-1"></i>
                        <%= post.commentCount || 0 %>
                      </span>
                    </td>
                    
                    <!-- 조회수 -->
                    <td class="text-center py-3">
                      <span class="text-muted">
                        <i class="fas fa-eye me-1"></i>
                        <%= post.views || 0 %>
                      </span>
                    </td>
                    
                    <!-- 좋아요 -->
                    <td class="text-center py-3">
                      <button class="btn btn-sm btn-outline-danger like-btn" 
                              onclick="toggleLike('<%= post._id %>', this)" 
                              data-post-id="<%= post._id %>"
                              style="border: none; background: none;">
                        <i class="fas fa-heart me-1 <%= user && post.isLiked ? 'text-danger' : 'text-muted' %>"></i>
                        <span class="like-count"><%= post.likes ? post.likes.length : 0 %></span>
                      </button>
                    </td>
                    
                    <!-- 작성일 -->
                    <td class="text-center py-3">
                      <small class="text-muted">
                        <%= new Date(post.createdAt).toLocaleDateString('ko-KR', { 
                          month: 'short', 
                          day: 'numeric',
                          year: new Date(post.createdAt).getFullYear() !== new Date().getFullYear() ? 'numeric' : undefined
                        }) %>
                      </small>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    <% } else { %>
      <div class="col-12">
        <div class="card border-0 shadow-sm">
          <div class="card-body text-center py-5">
            <div class="mb-4">
              <i class="fas fa-pen-fancy fa-4x text-primary opacity-50"></i>
            </div>
            <h3 class="text-dark mb-3">아직 작성된 게시글이 없습니다</h3>
            <p class="text-muted mb-4">
              커뮤니티의 첫 번째 글을 작성해보세요!<br>
              여러분의 소중한 경험과 이야기를 기다리고 있습니다.
            </p>
            <% if (user) { %>
              <a href="/posts/create" class="btn btn-primary btn-lg me-3">
                <i class="fas fa-plus me-2"></i>첫 글 작성하기
              </a>
              <a href="/posts?category=notice" class="btn btn-outline-primary btn-lg">
                <i class="fas fa-bullhorn me-2"></i>공지사항 보기
              </a>
            <% } else { %>
              <a href="/login" class="btn btn-primary btn-lg">
                <i class="fas fa-sign-in-alt me-2"></i>로그인하여 참여하기
              </a>
            <% } %>
          </div>
        </div>
      </div>
    <% } %>
  </div>

  <!-- 페이지네이션 -->
  <% if (pagination && pagination.totalPages > 1) { %>
    <nav aria-label="페이지 네비게이션" class="mt-5">
      <ul class="pagination justify-content-center">
        <% if (pagination.hasPrevPage) { %>
          <li class="page-item">
            <a class="page-link" href="/posts?page=<%= pagination.currentPage - 1 %>&category=<%= category %>&search=<%= search %>">
              <i class="fas fa-chevron-left"></i> 이전
            </a>
          </li>
        <% } %>

        <% for (let i = Math.max(1, pagination.currentPage - 2); i <= Math.min(pagination.totalPages, pagination.currentPage + 2); i++) { %>
          <li class="page-item <%= i === pagination.currentPage ? 'active' : '' %>">
            <a class="page-link" href="/posts?page=<%= i %>&category=<%= category %>&search=<%= search %>">
              <%= i %>
            </a>
          </li>
        <% } %>

        <% if (pagination.hasNextPage) { %>
          <li class="page-item">
            <a class="page-link" href="/posts?page=<%= pagination.currentPage + 1 %>&category=<%= category %>&search=<%= search %>">
              다음 <i class="fas fa-chevron-right"></i>
            </a>
          </li>
        <% } %>
      </ul>
    </nav>
  <% } %>
</div>

<style>
  .hover-card {
    transition: all 0.3s ease;
  }
  
  .hover-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.1) !important;
  }
  
  .badge {
    font-size: 0.75em;
  }

  /* AJAX로 동적 생성되는 등급별 배지 스타일 */
  .level-2-silver {
    background: linear-gradient(45deg, #c0c0c0, #e8e8e8) !important;
    color: #333 !important;
    border: 1px solid #b0b0b0 !important;
  }

  .level-4-platinum {
    background: linear-gradient(45deg, #8e44ad, #9b59b6, #e74c3c) !important;
    color: white !important;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3) !important;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2) !important;
  }

  .level-5-diamond {
    background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #feca57) !important;
    background-size: 300% 300% !important;
    animation: diamondShine 3s ease-in-out infinite !important;
    color: white !important;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3) !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2) !important;
  }

  @keyframes diamondShine {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
  }
</style>

<script>
// 게시글 삭제 함수 (전역 스코프)
function deletePost(postId) {
  if (confirm('정말로 이 게시글을 삭제하시겠습니까?')) {
    fetch(`/posts/${postId}/delete`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    })
    .then(response => {
      if (response.ok) {
        location.reload();
      } else {
        alert('삭제 중 오류가 발생했습니다.');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('삭제 중 오류가 발생했습니다.');
    });
  }
}

document.addEventListener('DOMContentLoaded', function() {

function toggleLike(postId, button) {
  event.stopPropagation();
  
  // 로그인 체크
  const isLoggedIn = <%= user ? 'true' : 'false' %>;
  if (!isLoggedIn) {
    alert('로그인이 필요합니다.');
    return;
  }
  
  fetch(`/posts/${postId}/like`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.liked !== undefined) {
      const icon = button.querySelector('i');
      const count = button.querySelector('.like-count');
      
      if (data.liked) {
        icon.classList.remove('text-muted');
        icon.classList.add('text-danger');
      } else {
        icon.classList.remove('text-danger');
        icon.classList.add('text-muted');
      }
      
      count.textContent = data.likesCount;
    } else {
      alert('좋아요 처리 중 오류가 발생했습니다.');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('좋아요 처리 중 오류가 발생했습니다.');
  });
}

function stopEventPropagation(event) {
  event.stopPropagation();
  event.preventDefault();
}
}); // DOMContentLoaded 이벤트 리스너 종료
</script>

<%- include('../partials/footer') %>

<!-- Bootstrap JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- AOS Animation Library - 지연 로딩 -->
<script>
// AOS 라이브러리 지연 로딩
function loadAOS() {
  const script = document.createElement('script');
  script.src = 'https://unpkg.com/aos@2.3.1/dist/aos.js';
  script.onload = function() {
    AOS.init({
      duration: 600,
      once: true,
      offset: 50
    });
  };
  document.head.appendChild(script);
}

document.addEventListener('DOMContentLoaded', function() {
  // 페이지 로드 후 AOS 초기화
  setTimeout(loadAOS, 100);

  // 현재 카테고리 상태 추적
  let currentCategory = '<%= category %>';

  // 카테고리 버튼 클릭 이벤트
  document.querySelectorAll('.category-btn').forEach(button => {
    button.addEventListener('click', function() {
      const category = this.getAttribute('data-category');
      
      // 버튼 상태 업데이트
      updateCategoryButtons(category);
      
      // 검색어 유지하면서 카테고리 필터 적용
      const searchValue = document.getElementById('searchInput').value.trim();
      loadPosts(category, searchValue);
    });
  });

  // 카테고리 버튼 상태 업데이트 함수
  function updateCategoryButtons(activeCategory) {
    currentCategory = activeCategory;
    document.getElementById('searchCategory').value = activeCategory;
    
    document.querySelectorAll('.category-btn').forEach(btn => {
      const category = btn.getAttribute('data-category');
      if (category === activeCategory) {
        btn.classList.remove('btn-outline-primary');
        btn.classList.add('btn-primary');
      } else {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline-primary');
      }
    });
  }

  // 게시글 로드 함수
  function loadPosts(category, search) {
    const searchBtn = document.getElementById('searchBtn');
    
    // 로딩 상태 표시
    searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    searchBtn.disabled = true;
    
    // AJAX 요청
    const params = new URLSearchParams();
    if (category && category !== 'all') {
      params.append('category', category);
    }
    if (search) {
      params.append('search', search);
    }
    
    fetch(`/posts?${params.toString()}`, {
      headers: {
        'Accept': 'application/json'
      }
    })
    .then(response => response.json())
    .then(data => {
      // 검색 결과로 게시글 목록 업데이트
      updatePostsList(data.posts);
      
      // URL 업데이트 (브라우저 뒤로가기 지원)
      const newUrl = `/posts?${params.toString()}`;
      window.history.pushState({}, '', newUrl);
    })
    .catch(error => {
      console.error('검색 오류:', error);
      alert('검색 중 오류가 발생했습니다.');
    })
    .finally(() => {
      // 로딩 상태 해제
      searchBtn.innerHTML = '<i class="fas fa-search"></i>';
      searchBtn.disabled = false;
    });
  }

  // AJAX 검색 기능
  document.getElementById('searchForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const searchValue = document.getElementById('searchInput').value.trim();
    loadPosts(currentCategory, searchValue);
  });

  // 게시글 목록 업데이트 함수
  function updatePostsList(posts) {
    const postsContainer = document.getElementById('postsContainer');
    
    // postsContainer가 존재하지 않으면 에러 방지
    if (!postsContainer) {
      console.error('postsContainer 요소를 찾을 수 없습니다.');
      return;
    }
    
    // posts가 유효하지 않으면 에러 방지
    if (!posts) {
      console.error('posts 데이터가 유효하지 않습니다.');
      return;
    }
    
    if (!posts || posts.length === 0) {
      postsContainer.innerHTML = `
        <tr>
          <td colspan="6" class="text-center py-5 text-muted">
            <i class="fas fa-search fa-2x mb-3"></i>
            <p class="mb-0">검색 결과가 없습니다.</p>
          </td>
        </tr>
      `;
      return;
    }
    
    let html = '';
    posts.forEach(post => {
      const categoryBadge = getCategoryBadge(post.category);
      const categoryText = getCategoryText(post.category);
      const createdDate = new Date(post.createdAt).toLocaleDateString('ko-KR');
      
      html += `
        <tr class="post-row" style="cursor: pointer;"
            data-category="${post.category}"
            data-title="${post.title}"
            data-author="${post.author ? post.author.name : '삭제된 사용자'}"
            data-comments="${post.commentCount || 0}"
            data-views="${post.views || 0}"
            data-date="${createdDate}">
          <td class="ps-4 py-3">
            <div class="d-flex align-items-start">
              <div class="flex-grow-1">
                <span class="badge rounded-pill me-5 ${categoryBadge}">
                  ${categoryText}
                </span>
                <h6 class="mb-1 fw-semibold">
                  <a href="/posts/${post._id}" class="text-decoration-none text-dark stretched-link">
                    ${post.title}
                  </a>
                  ${post.category === 'notice' ? '<i class="fas fa-thumbtack text-danger ms-1" title="공지사항"></i>' : ''}
                  ${post.isPrivate ? '<i class="fas fa-lock text-warning ms-1" title="비밀글"></i>' : ''}
                </h6>
                                 ${post.tags && post.tags.length > 0 ? `
                   <div class="mt-1">
                     ${post.tags.slice(0, 3).map(tag => `<span class="badge bg-light text-secondary" style="font-size: 0.7rem; margin-right: 0.1rem;">#${tag}</span>`).join('')}
                   </div>
                 ` : ''}
              </div>
            </div>
          </td>
            <td class="text-center py-3">
              <div class="d-flex flex-column align-items-center">
                ${post.author && post.author.profilePhoto ? `
                  <img src="${post.author.profilePhoto}" alt="프로필 사진" 
                       class="rounded-circle mb-1" style="width: 32px; height: 32px; object-fit: cover;">
                ` : `
                  <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center mb-1" 
                       style="width: 32px; height: 32px; font-size: 0.8rem;">
                    ${post.author && post.author.name ? post.author.name.charAt(0).toUpperCase() : '삭'}
                  </div>
                `}
                <div>
                  <small class="text-muted">
                    ${post.author && post.author.name ? post.author.name : '삭제된 사용자'}
                  </small>
                ${post.author && post.author.role === 'admin' ? `
                  <div class="mt-1">
                    <span class="badge bg-warning text-dark" style="font-size: 0.6rem;">
                      <i class="fas fa-crown me-1"></i>관리자
                    </span>
                  </div>
                ` : post.author && post.author.communityLevel && post.author.communityLevel.level ? `
                  <div class="mt-1">
                    <span class="badge ${getLevelBadgeClass(post.author.communityLevel.level)}" style="font-size: 0.6rem;">
                      <i class="${getLevelIcon(post.author.communityLevel.level)} me-1"></i>
                      ${post.author.communityLevel.title}
                    </span>
                  </div>
                ` : ''}
              </div>
            </div>
          </td>
          <td class="text-center py-3">
            <small class="text-muted">${post.commentCount || 0}</small>
          </td>
          <td class="text-center py-3">
            <small class="text-muted">${post.views || 0}</small>
          </td>
          <td class="text-center py-3">
            <small class="text-muted">${post.likes ? post.likes.length : 0}</small>
          </td>
          <td class="text-center py-3">
            <small class="text-muted">${createdDate}</small>
          </td>
        </tr>
      `;
    });
    
    postsContainer.innerHTML = html;
  }

  // 카테고리 배지 클래스 반환
  function getCategoryBadge(category) {
    switch(category) {
      case 'notice': return 'bg-danger';
      case 'info': return 'bg-success text-white';
      case 'qna': return 'bg-info text-white';
      default: return 'bg-secondary';
    }
  }

  // 카테고리 텍스트 반환
  function getCategoryText(category) {
    switch(category) {
      case 'general': return '자유';
      case 'info': return '정보 공유';
      case 'notice': return '공지';
      case 'qna': return 'Q&A';
      default: return category;
    }
  }

  // 등급별 배지 클래스 반환
  function getLevelBadgeClass(level) {
    switch(level) {
      case 1: return 'bg-secondary';      // 브론즈 - 회색
      case 2: return 'level-2-silver';    // 실버 - 그라데이션 회색
      case 3: return 'bg-warning text-dark'; // 골드 - 노란색
      case 4: return 'level-4-platinum';  // 플래티넘 - 보라색 그라데이션
      case 5: return 'level-5-diamond';   // 다이아몬드 - 무지개 그라데이션
      default: return 'bg-secondary';
    }
  }

  // 등급별 아이콘 반환
  function getLevelIcon(level) {
    switch(level) {
      case 1: return 'fas fa-medal';      // 브론즈 - 메달
      case 2: return 'fas fa-medal';      // 실버 - 메달
      case 3: return 'fas fa-medal';      // 골드 - 메달
      case 4: return 'fas fa-gem';        // 플래티넘 - 보석
      case 5: return 'fas fa-crown';      // 다이아몬드 - 왕관
      default: return 'fas fa-medal';
    }
  }

  // 게시글 행 클릭 이벤트 (중복 방지)
  document.addEventListener('click', function(e) {
    const postRow = e.target.closest('.post-row');
    if (postRow) {
      // 링크나 버튼 클릭 시에는 행 클릭 이벤트 실행하지 않음
      if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON' || e.target.closest('a') || e.target.closest('button') || e.target.closest('.dropdown')) {
        return;
      }
      
      // 게시글 ID 추출
      const postId = postRow.querySelector('a[href*="/posts/"]')?.href?.match(/\/posts\/([^\/]+)/)?.[1];
      if (postId) {
        console.log('📖 게시글 클릭:', postId);
        window.location.href = `/posts/${postId}`;
      }
    }
  });

  // Enter 키로도 검색 가능
  document.getElementById('searchInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      document.getElementById('searchForm').dispatchEvent(new Event('submit'));
    }
  });
}); // DOMContentLoaded 이벤트 리스너 종료
</script>

</body>
</html> 